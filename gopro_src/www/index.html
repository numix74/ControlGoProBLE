<!DOCTYPE html>
<html lang="fr" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GoPro Control</title>
    <!-- Google Fonts: Roboto & Material Symbols -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // Material 3 Palette (approximate)
                        md: {
                            primary: '#0061A4',
                            onPrimary: '#FFFFFF',
                            primaryContainer: '#D1E4FF',
                            onPrimaryContainer: '#001D36',
                            secondary: '#535F70',
                            onSecondary: '#FFFFFF',
                            surface: '#F8F9FF',
                            onSurface: '#191C20',
                            surfaceVariant: '#DFE2EB',
                            onSurfaceVariant: '#43474E',
                            outline: '#73777F',
                            error: '#BA1A1A',
                            darkSurface: '#111318',
                            darkOnSurface: '#E2E2E9',
                            darkSurfaceVariant: '#43474E',
                            darkOnSurfaceVariant: '#C3C7CF'
                        }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    },
                    borderRadius: {
                        'm3': '28px',
                    }
                },
            },
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .dot-red {
            background-color: #BA1A1A;
            box-shadow: 0 0 8px rgba(186, 26, 26, 0.4);
        }

        .dot-yellow {
            background-color: #E3E200;
            box-shadow: 0 0 8px rgba(227, 226, 0, 0.4);
        }

        .dot-green {
            background-color: #006C45;
            box-shadow: 0 0 8px rgba(0, 108, 69, 0.4);
        }

        /* Custom Scrollbar for modern look */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        /* Glassmorphism for Bottom Bar */
        .bottom-nav {
            backdrop-filter: blur(10px);
            background: rgba(248, 249, 255, 0.85);
        }

        .dark .bottom-nav {
            background: rgba(17, 19, 24, 0.85);
        }

        /* Active Preset chip effect */
        .active-preset {
            background-color: #D1E4FF !important;
            color: #001D36 !important;
            border: 1px solid #0061A4 !important;
        }

        .dark .active-preset {
            background-color: #004977 !important;
            color: #D1E4FF !important;
            border: 1px solid #D1E4FF !important;
        }

        /* Animation for Recording State */
        @keyframes pulse-red {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .recording-pulse {
            animation: pulse-red 1.5s infinite ease-in-out;
        }
    </style>
</head>

<body
    class="bg-md-surface dark:bg-md-darkSurface text-md-onSurface dark:text-md-darkOnSurface min-h-screen flex flex-col transition-colors duration-300">

    <!-- Top App Bar (M3) -->
    <header
        class="sticky top-0 z-50 flex items-center justify-between px-4 py-3 bg-md-surface dark:bg-md-darkSurface border-b border-md-surfaceVariant dark:border-md-darkSurfaceVariant">
        <div class="flex items-center space-x-3">
            <div id="connection-status-dot" class="connection-dot dot-red"></div>
            <h1 class="text-xl font-medium tracking-tight">GoPro Hero 11</h1>
        </div>
        <div class="flex items-center space-x-1">
            <button id="dark-mode-toggle"
                class="p-2 rounded-full hover:bg-md-surfaceVariant dark:hover:bg-md-darkSurfaceVariant transition-colors">
                <span class="material-symbols-outlined">dark_mode</span>
            </button>
            <button id="connect-button"
                class="p-2 rounded-full text-md-primary dark:text-md-primaryContainer hover:bg-md-primaryContainer dark:hover:bg-opacity-20 transition-all">
                <span class="material-symbols-outlined">bluetooth_connected</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow overflow-y-auto px-4 py-6 pb-32 space-y-6">

        <!-- Quick Status Chips Row -->
        <div id="status-chips" class="flex overflow-x-auto space-x-3 no-scrollbar pb-2">
            <div
                class="flex items-center bg-md-surfaceVariant dark:bg-md-darkSurfaceVariant px-3 py-2 rounded-full shrink-0">
                <span class="material-symbols-outlined text-sm mr-2">battery_horiz_075</span>
                <span id="status-battery-chip" class="text-sm font-medium">--%</span>
            </div>
            <div
                class="flex items-center bg-md-surfaceVariant dark:bg-md-darkSurfaceVariant px-3 py-2 rounded-full shrink-0">
                <span class="material-symbols-outlined text-sm mr-2">sd_card</span>
                <span id="status-sd-chip" class="text-sm font-medium">-- GB</span>
            </div>
            <div
                class="flex items-center bg-md-surfaceVariant dark:bg-md-darkSurfaceVariant px-3 py-2 rounded-full shrink-0">
                <span class="material-symbols-outlined text-sm mr-2">thermostat</span>
                <span id="status-temp-chip" class="text-sm font-medium">--°</span>
            </div>
        </div>

        <!-- Connection Placeholder / Error -->
        <div id="connection-overlay"
            class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-m3 border border-blue-100 dark:border-blue-800 text-center space-y-2">
            <p id="connection-status-text" class="text-md-primary dark:text-blue-300 font-medium italic">Cliquez sur
                l'icône Bluetooth pour vous connecter.</p>
            <p id="error-message" class="text-xs text-md-error animate-pulse"></p>
        </div>

        <!-- Section Controls Hidden by Default -->
        <div id="controls-section" class="hidden space-y-6">

            <!-- Dynamic Presets Grid -->
            <section id="presets-section" class="space-y-3">
                <div class="flex items-center justify-between">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-md-outline dark:text-gray-400">Modes &
                        Presets</h2>
                    <span id="presets-feedback" class="text-xs text-md-primary italic"></span>
                </div>
                <div id="presets-container" class="grid grid-cols-2 gap-3">
                    <!-- Presets will be injected as Material Chips/Buttons here -->
                    <div class="animate-pulse bg-md-surfaceVariant h-10 rounded-full"></div>
                    <div class="animate-pulse bg-md-surfaceVariant h-10 rounded-full"></div>
                </div>
            </section>

            <!-- Settings Card -->
            <section id="settings-section"
                class="bg-md-surfaceVariant/50 dark:bg-md-darkSurfaceVariant/30 rounded-m3 p-5 space-y-4">
                <h2 class="text-sm font-bold uppercase tracking-widest text-md-outline dark:text-gray-400 mb-2">
                    Paramètres Rapides</h2>

                <div id="settings-container" class="space-y-4">
                    <!-- Timer Setting (Special) -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="material-symbols-outlined text-md-primary">timer</span>
                            <div>
                                <p class="text-sm font-medium">Timer Enregistrement</p>
                                <p class="text-xs text-md-outline">Arrêt auto après X sec</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="timer-toggle-checkbox" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-md-outline peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-md-primary">
                            </div>
                        </label>
                    </div>
                    <div id="timer-input-area" class="pl-11 opacity-50 pointer-events-none transition-opacity">
                        <input type="number" id="timed-duration" value="30" min="1"
                            class="bg-transparent border-b border-md-outline w-16 text-center focus:border-md-primary outline-none text-sm">
                        <span class="text-xs ml-2 uppercase text-md-outline">secondes</span>
                    </div>

                    <hr class="border-md-surfaceVariant dark:border-md-darkSurfaceVariant">

                    <!-- Video Settings -->
                    <div id="setting-item-2" class="setting-row flex items-center justify-between hidden">
                        <span class="text-sm font-medium">Résolution</span>
                        <select id="setting-2"
                            class="bg-transparent text-sm text-md-primary font-bold focus:outline-none"></select>
                    </div>
                    <div id="setting-item-3" class="setting-row flex items-center justify-between hidden">
                        <span class="text-sm font-medium">Images / sec</span>
                        <select id="setting-3"
                            class="bg-transparent text-sm text-md-primary font-bold focus:outline-none"></select>
                    </div>
                    <div id="setting-item-121" class="setting-row flex items-center justify-between hidden">
                        <span class="text-sm font-medium">Objectif</span>
                        <select id="setting-121"
                            class="bg-transparent text-sm text-md-primary font-bold focus:outline-none"></select>
                    </div>
                </div>
            </section>

            <!-- Detailed Status (Collapsible) -->
            <section id="status-section"
                class="bg-white dark:bg-gray-800/40 rounded-m3 p-5 border border-md-surfaceVariant dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-bold uppercase tracking-widest text-md-outline">Détails Système</h2>
                    <button id="toggle-status-button" class="text-xs text-md-primary font-bold">MODE RÉDUIT</button>
                </div>
                <div id="status-grid" class="grid grid-cols-2 gap-4 text-xs">
                    <div class="space-y-1">
                        <p class="text-md-outline uppercase font-bold text-[10px]">Stockage</p>
                        <p id="status-sd-capacity" class="font-medium">-- GB total</p>
                        <p id="status-video-remaining" class="text-md-primary font-bold">-- min restants</p>
                    </div>
                    <div class="space-y-1">
                        <p class="text-md-outline uppercase font-bold text-[10px]">État encodage</p>
                        <p id="status-encoding" class="font-medium">Repos</p>
                        <p id="status-busy" class="italic opacity-70">Prêt</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Bottom Navigation Bar (Hero Action) -->
    <nav
        class="bottom-nav fixed bottom-0 w-full px-6 py-4 border-t border-md-surfaceVariant dark:border-md-darkSurfaceVariant flex flex-col items-center space-y-4">

        <!-- Shutter Feedback Flash -->
        <div id="shutter-feedback" class="text-xs font-bold text-md-primary h-4 transition-all"></div>

        <div class="flex items-center justify-center space-x-8 w-full">
            <!-- Hilight Button -->
            <button id="hilight-button" disabled
                class="p-4 rounded-full bg-md-surfaceVariant dark:bg-md-darkSurfaceVariant text-md-outline disabled:opacity-30 transition-all active:scale-95 shadow-lg">
                <span class="material-symbols-outlined">stars</span>
            </button>

            <!-- Primary Action (Recording) -->
            <div class="relative">
                <!-- Outer ring for recording animation -->
                <div id="record-ring"
                    class="absolute -inset-2 rounded-full border-4 border-red-500 opacity-0 transition-opacity"></div>
                <button id="main-action-button"
                    class="w-16 h-16 rounded-full bg-red-600 flex items-center justify-center shadow-xl active:scale-90 transition-transform">
                    <div id="record-icon-inner" class="w-6 h-6 rounded-full bg-white transition-all"></div>
                </button>
            </div>

            <!-- Stop Action (Optional/Redundant with Main) -->
            <button id="stop-record-button" disabled
                class="p-4 rounded-full bg-md-surfaceVariant dark:bg-md-darkSurfaceVariant text-md-outline disabled:opacity-30 transition-all active:scale-95 shadow-lg">
                <span class="material-symbols-outlined">stop_circle</span>
            </button>
        </div>

        <!-- Safe margin for gesture nav -->
        <div class="h-2"></div>
    </nav>

    <!-- Load Local scripts -->
    <script src="./protobuf.min.js"></script>
    <script src="./gopro_ble.js"></script>
    <script src="capacitor.js"></script>

    <script>
        // UI Polish: Handle Timer UI state
        const timerCheckbox = document.getElementById('timer-toggle-checkbox');
        const timerArea = document.getElementById('timer-input-area');
        if (timerCheckbox) {
            timerCheckbox.addEventListener('change', (e) => {
                timerArea.style.opacity = e.target.checked ? '1' : '0.5';
                timerArea.style.pointerEvents = e.target.checked ? 'auto' : 'none';

                // Trigger the actual logic in gopro_ble.js if needed
                const oldToggle = document.getElementById('timer-toggle-button');
                if (oldToggle) oldToggle.click();
            });
        }

        // Connect status dot sync
        function updateM3Dot(colorClass) {
            const dot = document.getElementById('connection-status-dot');
            dot.className = 'connection-dot ' + colorClass;
        }

        // Override existing updateConnectionStatus to use M3 Dot
        const originalUpdateStatus = window.updateConnectionStatus;
        window.updateConnectionStatus = function (text, colorClass) {
            if (originalUpdateStatus) originalUpdateStatus(text, colorClass);
            updateM3Dot(colorClass);
            const statusText = document.getElementById('connection-status-text');
            if (statusText) statusText.textContent = text;

            const overlay = document.getElementById('connection-overlay');
            if (text === 'Prêt') {
                overlay.classList.add('hidden');
            } else {
                overlay.classList.remove('hidden');
            }
        };

        // UI Feedback for Recording
        function updateRecordingUI(isRecording) {
            const mainBtn = document.getElementById('main-action-button');
            const inner = document.getElementById('record-icon-inner');
            const ring = document.getElementById('record-ring');

            if (isRecording) {
                inner.classList.replace('w-6', 'w-4');
                inner.classList.replace('h-6', 'h-4');
                inner.classList.replace('rounded-full', 'rounded-sm');
                ring.classList.remove('opacity-0');
                ring.classList.add('recording-pulse');
            } else {
                inner.classList.replace('w-4', 'w-6');
                inner.classList.replace('h-4', 'h-6');
                inner.classList.replace('rounded-sm', 'rounded-full');
                ring.classList.add('opacity-0');
                ring.classList.remove('recording-pulse');
            }
        }
    </script>
</body>

</html>